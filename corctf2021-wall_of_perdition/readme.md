```c
struct msg_msg {
	struct list_head m_list;
	long m_type;
	size_t m_ts;		/* message text size */
	struct msg_msgseg *next;
	void *security;
	/* the actual message follows immediately */
};
```
User msg stored right after `msg_msg` structure uptil `0x1000 - 0x30` after that singly linked list of chunks stored in `struct msg_msgseg *next` with size of each allocation upto `0x1000`, is and should be `NULL` terminated.
## Arbitrary read:
overwrite `next` and `m_ts` to be such that, it has to read from overwritten `next` pointer.

## Arbitrary free:
Overwrite msg_msg with correct `m_list` pointers, small size(so that it doesn't copy out of slab and hence make the `copy_to_user` crash).
Overwrite `msg_msgseg *next` with "The Address".
Call `msgrcv()` without `MSG_COPY` flag and free the `msg_msg` structure along with "The Address".
Note "The Address" should point to `NULL` otherwise it will crash kernel, check copy_msg/load_msg for explanation.
Also this can be made `NULL` when allocating chunks in `load_msg` if you can be smart ;)

## Arbitrary write:

```c
msgsnd()		// Userland
	do_msgsnd()	// Kernel land
		load_msg()	
			alloc_msg()			// Allocate all the necessary chunks
			copy_from_user()	// Race here to replace `struct msg_msgseg *next` before its used to copy userdata. Maybe use userfaultfd ;)
```
Since we dont have UAF in 0x1000 chunk, we cant directly race in `load_msg` bcz `len` is already fixed. Instead use interleaved `msgsnd`s and UAF in random size chunks as explained above to overwrite the `msg_msgseg *next` pointer to `arbitrary_address`, again it should point to `NULL` and be careful to not write out of bounds of any slab. Check script or the nice writeup by author (@D3v17) linked in references.

 - [https://blog.hacktivesecurity.com/index.php/2022/06/13/linux-kernel-exploit-development-1day-case-study](https://blog.hacktivesecurity.com/index.php/2022/06/13/linux-kernel-exploit-development-1day-case-study)
 - [https://duasynt.com/blog/linux-kernel-heap-feng-shui-2022](https://duasynt.com/blog/linux-kernel-heap-feng-shui-2022)
 - [https://syst3mfailure.io/wall-of-perdition](https://syst3mfailure.io/wall-of-perdition)
 - [https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L840](https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L840)