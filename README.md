# Kernel-exploitation
## compress.sh
Compile the exploit, add it to fs, and run.
```bash
#!/bin/sh
gcc -w -o exploit -static exploit.c -pthread -lrt &&\
# musl-gcc -w -s -static -o3 exploit.c -o exploit -masm=intel &&\
mv exploit ./fs/ &&\
cd fs &&\
find . -print0 | cpio --owner root --null -ov --format=newc | gzip -9 > ../initramfs.cpio.gz &&\
cd .. &&\
# gunzip -f initramfs.cpio.gz &&\
./run.sh
```
## decompress.sh
Extract file from CPIO archive
```bash
#!/bin/sh
mkdir fs
cd fs
cp ../initramfs.cpio.gz ./initramfs.cpio.gz
gunzip ./initramfs.cpio.gz
cpio -idm < ./initramfs.cpio
rm initramfs.cpio
cd ..
```
In case ext4 filesystem archive
```bash
mount ./initramfs.cpio.gz ./fs/
```
### [extract-image.sh](https://github.com/ameetsaahu/Kernel-exploitation/raw/main/seccon2020-kstack/extract-image.sh)
## Useful strcutures
### ldt_struct - modify_ldt syscall
0x20 size struct, contains no checks for copy_to_user call
 - [https://elixir.bootlin.com/linux/v4.19.98/source/arch/x86/kernel/ldt.c#L553](https://elixir.bootlin.com/linux/v4.19.98/source/arch/x86/kernel/ldt.c#L553)
 - [https://github.com/ameetsaahu/Kernel-exploitation/tree/main/0ctffinal2021-kernote](https://github.com/ameetsaahu/Kernel-exploitation/tree/main/0ctffinal2021-kernote)

## Misc
### To restrict the process to run on specific CPU
```C
cpu_set_t cpu_set;
CPU_ZERO(&cpu_set);
CPU_SET(0,&cpu_set);
ret=sched_setaffinity(0,sizeof(cpu_set),&cpu_set);
```

## References
 - [https://github.com/xairy/linux-kernel-exploitation](https://github.com/xairy/linux-kernel-exploitation) by [@andreyknvl](https://twitter.com/andreyknvl)
 - [Structures collection useful for kernel-exp](https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628) by [@ptr-yudai](https://twitter.com/ptrYudai)